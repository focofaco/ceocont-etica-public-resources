name: "Daily Health Check Agent"

# Dead-simple autonomous agent that runs daily health checks
# Task: Check repository health and report status

on:
  schedule:
    # Every day at 08:00 BRT (11:00 UTC)
    - cron: '0 11 * * *'
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  issues: write

jobs:
  health-check-agent:
    name: ğŸ¤– Health Check Agent
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: ğŸ” Agent Task - Check Repository Health
        id: health-check
        run: |
          echo "ğŸ¤– Agent starting health check..."

          # Count files
          TOTAL_TXT=$(find online-resources/raw-text -name "*.txt" -type f ! -path "*/meta/*" | wc -l)
          TOTAL_JSON=$(find online-resources/raw-text -name "*.json" -type f ! -path "*/meta/*" | wc -l)

          # Check git status
          UNCOMMITTED=$(git status --short | wc -l)

          # Check disk usage
          REPO_SIZE=$(du -sh . | cut -f1)

          # Generate report
          cat > health-report.md << EOF
          # ğŸ¥ Daily Health Check Report

          **Date**: $(date +%Y-%m-%d)
          **Time**: $(date +%H:%M:%S) BRT
          **Agent**: Health Check Bot ğŸ¤–

          ## Repository Stats

          - ğŸ“„ Total .txt files: **$TOTAL_TXT**
          - ğŸ“‹ Total .json files: **$TOTAL_JSON**
          - ğŸ’¾ Repository size: **$REPO_SIZE**
          - ğŸ“Š Uncommitted changes: **$UNCOMMITTED**

          ## Health Status

          $(if [ "$TOTAL_TXT" -eq "$TOTAL_JSON" ]; then
              echo "âœ… **Metadata twins in sync** (txt = json)"
          else
              echo "âš ï¸ **Metadata mismatch** (txt: $TOTAL_TXT, json: $TOTAL_JSON)"
          fi)

          $(if [ "$UNCOMMITTED" -eq 0 ]; then
              echo "âœ… **No uncommitted changes**"
          else
              echo "âš ï¸ **Uncommitted changes detected**: $UNCOMMITTED file(s)"
          fi)

          $(if [ "$TOTAL_TXT" -gt 0 ]; then
              echo "âœ… **Repository has content**"
          else
              echo "âŒ **No content files found**"
          fi)

          ## Agent Verdict

          **Overall Status**: $(if [ "$TOTAL_TXT" -eq "$TOTAL_JSON" ] && [ "$UNCOMMITTED" -eq 0 ]; then echo "ğŸŸ¢ HEALTHY"; else echo "ğŸŸ¡ NEEDS ATTENTION"; fi)

          ---

          *Generated by Daily Health Check Agent*
          EOF

          cat health-report.md
          echo "health_status=$(if [ "$TOTAL_TXT" -eq "$TOTAL_JSON" ] && [ "$UNCOMMITTED" -eq 0 ]; then echo "healthy"; else echo "attention"; fi)" >> $GITHUB_OUTPUT

      - name: ğŸ“Š Display Report in Summary
        run: |
          cat health-report.md >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“ Create Issue if Unhealthy
        if: steps.health-check.outputs.health_status == 'attention'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('health-report.md', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ Repository Health Check - Attention Needed',
              body: report,
              labels: ['health-check', 'automated'],
            });

      - name: âœ… Agent Task Complete
        run: |
          echo "ğŸ¤– Agent task completed successfully!"
          echo "Status: ${{ steps.health-check.outputs.health_status }}"
