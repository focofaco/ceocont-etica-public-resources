name: "Pre-commit Checks"

# Run pre-commit hooks on PRs to catch issues early
# Auto-fix capability: ENABLED - commits fixes back to PR automatically

on:
  pull_request:
    branches: [ '**' ]
  push:
    branches: [ main ]

jobs:
  pre-commit:
    name: Run Pre-commit Hooks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for better pre-commit analysis
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: Run pre-commit hooks
        id: pre-commit
        run: |
          # Run pre-commit on all files (or just changed files)
          # Use --show-diff-on-failure to see what failed
          pre-commit run --all-files --show-diff-on-failure --color=always
        continue-on-error: true

      # Auto-fix and commit back to PR
      # ENABLED: This will commit to PRs automatically!
      - name: Commit pre-commit fixes
        if: failure() && steps.pre-commit.outcome == 'failure'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-fix pre-commit issues"
          commit_user_name: "pre-commit-ci[bot]"
          commit_user_email: "pre-commit-ci[bot]@users.noreply.github.com"

      - name: Pre-commit Summary
        if: always()
        run: |
          echo "::notice::Pre-commit hooks completed. Check logs above for details."
          if [ "${{ steps.pre-commit.outcome }}" == "failure" ]; then
            echo "::error::Some pre-commit hooks failed. Run 'pre-commit run --all-files' locally to fix."
          fi
