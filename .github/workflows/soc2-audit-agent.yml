name: "SOC2 Audit Trail Agent"

# Autonomous agent that maintains immutable audit trail for compliance
# Tracks all changes with who/what/when for SOC2 compliance

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ opened, closed ]
  release:
    types: [ published ]
  workflow_dispatch:

permissions:
  contents: write
  issues: read
  pull-requests: read

jobs:
  audit-trail:
    name: ðŸ“‹ SOC2 Audit Agent
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for audit

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: ðŸ¤– Agent Task - Generate Audit Log Entry
        id: audit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'EOF'
          import json
          import os
          import subprocess
          from datetime import datetime, timezone
          from pathlib import Path

          print("ðŸ¤– Agent generating audit trail entry...")

          # Gather event information
          event_name = os.getenv('GITHUB_EVENT_NAME', 'unknown')
          ref = os.getenv('GITHUB_REF', 'unknown')
          sha = os.getenv('GITHUB_SHA', 'unknown')
          actor = os.getenv('GITHUB_ACTOR', 'unknown')
          run_id = os.getenv('GITHUB_RUN_ID', 'unknown')
          repository = os.getenv('GITHUB_REPOSITORY', 'unknown')

          # Get commit details if available
          commit_info = {}
          if event_name == 'push':
              result = subprocess.run(
                  ['git', 'log', '-1', '--format=%H|%an|%ae|%at|%s'],
                  capture_output=True,
                  text=True
              )
              if result.returncode == 0:
                  parts = result.stdout.strip().split('|')
                  if len(parts) == 5:
                      commit_info = {
                          'sha': parts[0],
                          'author_name': parts[1],
                          'author_email': parts[2],
                          'timestamp': int(parts[3]),
                          'message': parts[4]
                      }

          # Create audit entry
          audit_entry = {
              'id': f"{event_name}_{sha[:8]}_{run_id}",
              'timestamp': datetime.now(timezone.utc).isoformat(),
              'event_type': event_name,
              'actor': actor,
              'repository': repository,
              'ref': ref,
              'sha': sha,
              'run_id': run_id,
              'commit': commit_info if commit_info else None,
              'compliance': {
                  'framework': 'SOC2',
                  'control': 'CC6.1 - Logical Access Controls',
                  'description': 'Audit trail of all changes to repository'
              }
          }

          # Create audit directory if not exists
          audit_dir = Path('.github/audit-trail')
          audit_dir.mkdir(parents=True, exist_ok=True)

          # Save audit entry (append to daily log)
          today = datetime.now(timezone.utc).strftime('%Y-%m-%d')
          audit_file = audit_dir / f'audit-{today}.jsonl'

          with open(audit_file, 'a') as f:
              f.write(json.dumps(audit_entry) + '\n')

          print(f"âœ… Audit entry created: {audit_entry['id']}")
          print(json.dumps(audit_entry, indent=2))

          # Generate daily summary
          with open(audit_file, 'r') as f:
              entries = [json.loads(line) for line in f]

          summary = {
              'date': today,
              'total_events': len(entries),
              'event_types': {},
              'actors': {}
          }

          for entry in entries:
              event_type = entry['event_type']
              actor = entry['actor']
              summary['event_types'][event_type] = summary['event_types'].get(event_type, 0) + 1
              summary['actors'][actor] = summary['actors'].get(actor, 0) + 1

          print("\nðŸ“Š Daily Audit Summary:")
          print(json.dumps(summary, indent=2))

          with open('GITHUB_OUTPUT', 'a') as f:
              f.write(f"audit_id={audit_entry['id']}\n")
              f.write(f"audit_file={audit_file}\n")
          EOF

      - name: Commit audit trail
        run: |
          git config user.name "soc2-audit-bot[bot]"
          git config user.email "soc2-audit-bot[bot]@users.noreply.github.com"

          git add .github/audit-trail/

          if ! git diff --staged --quiet; then
            git commit -m "audit: add SOC2 audit trail entry ${{ steps.audit.outputs.audit_id }}"
            git push origin HEAD:main || echo "Failed to push audit trail"
          else
            echo "No audit changes to commit"
          fi

      - name: Generate compliance report
        run: |
          cat > audit-report.md << 'EOF'
          # ðŸ“‹ SOC2 Audit Trail Report

          **Audit Entry ID**: ${{ steps.audit.outputs.audit_id }}
          **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Event**: ${{ github.event_name }}
          **Actor**: ${{ github.actor }}

          ## Compliance Framework

          - **Standard**: SOC2 Type II
          - **Control**: CC6.1 - Logical and Physical Access Controls
          - **Description**: Organization implements logical access security to protect information assets

          ## Audit Trail Properties

          âœ… **Immutable**: Append-only log (no deletions)
          âœ… **Complete**: All events captured
          âœ… **Timestamped**: UTC timezone
          âœ… **Attributed**: Actor identification
          âœ… **Searchable**: JSON Lines format

          ## Retention

          - **Retention period**: 7 years (SOC2 requirement)
          - **Storage**: Git repository (immutable)
          - **Access control**: Repository permissions

          ## Query Audit Trail

          ```bash
          # View today's audit entries
          cat .github/audit-trail/audit-$(date +%Y-%m-%d).jsonl | jq

          # Search by actor
          grep '"actor":"username"' .github/audit-trail/*.jsonl

          # Count events by type
          cat .github/audit-trail/*.jsonl | jq -r '.event_type' | sort | uniq -c
          ```

          ---

          *Automated audit trail maintained by SOC2 Audit Agent*
          EOF

          cat audit-report.md

      - name: Display report in summary
        run: |
          cat audit-report.md >> $GITHUB_STEP_SUMMARY

      - name: âœ… Agent Task Complete
        run: |
          echo "ðŸ¤– SOC2 audit agent completed!"
          echo "Audit entry: ${{ steps.audit.outputs.audit_id }}"
          echo "Audit file: ${{ steps.audit.outputs.audit_file }}"
